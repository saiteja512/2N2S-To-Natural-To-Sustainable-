<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Rainwater Harvesting Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-slate-100">

  <div class="container mx-auto p-4 md:p-8">
    <header class="mb-8">
      <h1 class="text-3xl font-bold text-slate-800">Rainwater Management Dashboard</h1>
      <p class="text-slate-500">Real-time monitoring and prediction for efficient water usage.</p>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      
      <!-- Tank Status Card -->
      <div class="bg-white p-6 rounded-lg shadow-md col-span-1 md:col-span-2 lg:col-span-1">
        <h2 class="text-xl font-semibold text-slate-700 mb-4">Tank Status</h2>
        <div class="relative w-full max-w-xs mx-auto">
          <canvas id="tankGauge"></canvas>
          <div id="tankLevelText" class="absolute inset-0 flex flex-col items-center justify-center text-slate-800 pointer-events-none">
            <span class="text-4xl font-bold">...</span>
            <span class="text-lg text-slate-500">Liters</span>
          </div>
        </div>
      </div>

      <!-- Prediction & System Insights Card -->
      <div class="bg-white p-6 rounded-lg shadow-md col-span-1 md:col-span-2">
        <h2 class="text-xl font-semibold text-slate-700 mb-4">System Insights & Prediction</h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
          <div class="bg-slate-50 p-4 rounded-md">
            <h3 class="text-sm font-medium text-slate-500">Weather Forecast (24h)</h3>
            <p id="forecast" class="text-2xl font-bold text-sky-600">... mm</p>
          </div>
          <div class="bg-slate-50 p-4 rounded-md">
            <h3 class="text-sm font-medium text-slate-500">Current Water Usage</h3>
            <p id="usage" class="text-2xl font-bold text-amber-600">... L/day</p>
          </div>
          <div class="bg-sky-100 border border-sky-300 p-4 rounded-md">
            <h3 class="text-sm font-medium text-sky-800">Predicted Level (24h)</h3>
            <p id="prediction" class="text-2xl font-bold text-sky-900">... Liters</p>
          </div>
        </div>
        <div id="systemMessage" class="mt-6 bg-green-100 border border-green-300 text-green-800 p-4 rounded-md text-center">
          <p class="font-semibold">System status is nominal.</p>
        </div>
      </div>
      
    </main>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- CONFIGURATION ---
  const TANK_CAPACITY = 3000; // Liters
  const API_URL = 'http://127.0.0.1:5000/';
  const USE_MOCK = false; // Change to false to use real backend

  // --- STATE VARIABLES ---
  let currentTankLevel = 2500; // Starting simulated level
  let tankGaugeChart;

  // --- UI ELEMENTS ---
  const tankLevelValueEl = document.querySelector('#tankLevelText span:first-child');
  const forecastEl = document.getElementById('forecast');
  const usageEl = document.getElementById('usage');
  const predictionEl = document.getElementById('prediction');
  const systemMessageEl = document.getElementById('systemMessage');

  // --- GAUGE CHART SETUP ---
  const createGauge = () => {
    const ctx = document.getElementById('tankGauge').getContext('2d');
    tankGaugeChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        datasets: [{
          data: [currentTankLevel, TANK_CAPACITY - currentTankLevel],
          backgroundColor: ['#0284c7', '#e2e8f0'],
          borderWidth: 0,
          circumference: 180,
          rotation: 270,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        cutout: '80%',
        plugins: {
          tooltip: { enabled: false }
        }
      }
    });
  };
  
  // --- UPDATE FUNCTIONS ---
  const updateGauge = (level) => {
    const safeLevel = Math.max(0, Math.min(TANK_CAPACITY, level));
    tankLevelValueEl.textContent = Math.round(safeLevel);
    tankGaugeChart.data.datasets[0].data = [safeLevel, TANK_CAPACITY - safeLevel];
    tankGaugeChart.update('none');
  };

  const updateSystemMessage = (level, prediction) => {
    const percentage = (level / TANK_CAPACITY) * 100;
    let message = 'System status is nominal.';
    let bgColor = 'bg-green-100';
    let borderColor = 'border-green-300';
    let textColor = 'text-green-800';

    if (prediction > TANK_CAPACITY) {
      message = '<strong>Warning:</strong> Tank may overflow in the next 24 hours.';
      bgColor = 'bg-amber-100';
      borderColor = 'border-amber-300';
      textColor = 'text-amber-800';
    } else if (percentage < 20) {
      message = '<strong>Alert:</strong> Tank level is low. Conserve water.';
      bgColor = 'bg-red-100';
      borderColor = 'border-red-300';
      textColor = 'text-red-800';
    }
    
    systemMessageEl.innerHTML = `<p>${message}</p>`;
    systemMessageEl.className = `mt-6 p-4 rounded-md text-center ${bgColor} ${borderColor} ${textColor}`;
  };

  // --- MOCK API CALL ---
  const mockApiCall = (currentLevel, usage, forecast) => {
    return new Promise(resolve => {
      setTimeout(() => {
        const rainfallCollection = forecast * 12; 
        const predicted_level = currentLevel - usage + rainfallCollection;
        resolve({ predicted_level: predicted_level });
      }, 500);
    });
  };

  // --- API CALL ---
  const getPrediction = async () => {
    const rainfallForecast = 5 + Math.random() * 20;
    const waterUsage = 150 + Math.random() * 50;

    forecastEl.textContent = `${rainfallForecast.toFixed(1)} mm`;
    usageEl.textContent = `${waterUsage.toFixed(0)} L/day`;
    predictionEl.textContent = 'Calculating...';

    try {
      let data;
      if (USE_MOCK) {
        data = await mockApiCall(currentTankLevel, waterUsage, rainfallForecast);
      } else {
        const response = await fetch(API_URL, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    current_tank_level: currentTankLevel,
    water_usage: waterUsage,
    rainfall_forecast: rainfallForecast
  })
});


        if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
        data = await response.json();
      }

      const predictedLevel = Math.min(TANK_CAPACITY, data.predicted_level || data.prediction);
      predictionEl.textContent = `${Math.round(predictedLevel)} Liters`;
      updateSystemMessage(currentTankLevel, predictedLevel);

    } catch (error) {
      console.error("Failed to fetch prediction:", error);
      predictionEl.textContent = 'Error';
      systemMessageEl.innerHTML = '<p>Could not connect to the prediction server. Running in offline mode.</p>';
      systemMessageEl.className = 'mt-6 bg-red-100 border border-red-300 text-red-800 p-4 rounded-md text-center';
    }
  };

  // --- SIMULATION ---
  const simulateRealTimeData = () => {
    const usageChange = Math.random() * 2;
    currentTankLevel -= usageChange;
    updateGauge(currentTankLevel);
  };

  // --- INITIALIZATION ---
  createGauge();
  updateGauge(currentTankLevel);
  getPrediction();

  setInterval(getPrediction, 30000);
  setInterval(simulateRealTimeData, 3000);
});
</script>
</body>
</html>
